language: node_js

node_js:
  - lts/*

env:
  global:
    - secure: rSyiWcNIeQnSZfpTFTRQT0hlZckaTenQVmHU1idsrYroiMn4J3KJxy9/4ISA99DMjDxgXX2S52r09TMVbFYdakL99sCsG6Mpwb6OlbzG9oAbW2j0jiHqfESWCTHipXifSUEDZB8h1XiWep2b90bdA9Jh/UbvXll0ykN1I5C3bK3LQO2RUWQaBrFwhOXuUPCdpOe7MKhZeXPXbCqx3IT+L3lWHlqscR4LkwgvRJp6i2C2cAHszoOeIme4LbmKhLUZ1yA5p5GwSrH9FjbXv22/wzkhMof64uBuAmsnafIOC1keRoG0a/HQGlQT6hNd+Xn4KGfFvnqb0xAoFsSKb3+CEdHcWmA+Q/s9DrCgH43i8J5Ts63JFPPS0wtqy0luigI50tIQOMTP3itanfju3DiMj/SF2lZnp5NyKjHo7VjO9/GkhJ/swi1qec56lT2o8DBvQaZoNoSxaTbhjdjt5ya7DlXE4Q3YWMJ/BthEmIHN8rrsFC5vQINi85DoOuaAzA0QwtYZWb6Xna1RkXZ2u33R6LUStaU0mS3zme16qaCrmEKIvTdBoahbZfDDdyrGboGZiN0GuXO/LQWoWNYEW6pypHAVfe2BngvNJECFIEkfTY2A76CcMoa/mObIEUAeRHVmAZTYfUO5AKk/OU24RZ5w5fBrHV7EQ8hGHUKOVrY4teA=
    - secure: ddEBkejFbMgeGADIAaB0C+QoebVpymxD1pwsJDsv26EV+B+F+VUdsjHi+ljgh++Xmi8rO/kre0xLPJVWBG2mt0LGmld2DDq3LXiYVZuRcQQEs/O/+DlbxMaFrbWdlc0aP73QPHqvu9Ka3bjShxuELKWpQ6N8KgYReJNt13kNn9LthtYi7i0rxnqeb7dVQvdVNqttst4ASq/ywvJc6tl8ry76v4+MvK3DmE77sXSLBdyDNw1ZeLGP5HOzaYTPh3aB0GYdmRTqLmUxo0eyCg2fyzL2aPdgEmIzzdfcYfZztDLOKGqlp5oc0IiUS5HWwq1HUNjVAf3kTKrHn9Sh+PfMHHZC0eGQ2aQMQeqMjK+S4frsGn0tZ2fiJzpGf+Jbb2Odf0tDD7ZidVzsARbEXF0MFQtzETU0ROpIC6TZ3JMsJeJ/E+Zo5/FMztMvGhPqgkNZI1LkcP+VcBU07aUy3IXBWucaMGYX3We1DoAKHjpe87I2JHaxZPYPZ1lLL6qMhoVU/gSRzLdN9JoVmVRSeNTcw++n8Mw11cSUVIAUxg0rajc4SvzwaF0FvjAFeTezUfJOZMPpOquC8IivjnFCv4pWiGVgDxr2dhtYi/1FfCFCkF3p5/Ic1LlnCK872hm2ytFjnubkLO6l3MeR+RHqLMXrcNLVVG8sFzajNoCHt3ExaZQ=

jobs:
  include:
    - stage: test
      services:
        - mysql
      env:
        - NODE_ENV=test
      before_install:
        - npm i npm yarn -g
        - mysql -e 'CREATE DATABASE database_test;'
      script:
        - yarn lint
        - yarn start:test
        - yarn test
        - cat ~/.pm2/logs/index-out.log
    - stage: deploy
      env:
        - NODE_ENV=production
      before_install:
        - openssl aes-256-cbc -K $encrypted_d80369b7a19f_key -iv $encrypted_d80369b7a19f_iv
          -in travis_rsa.enc -out travis_rsa -d
        - chmod 600 travis_rsa
        - mv travis_rsa ~/.ssh/id_rsa
        - mv travis_rsa.pub ~/.ssh/id_rsa.pub
      after_success:
        - JWT_SECRET=$JWT_SECRET SALT_ROUNDS=$SALT_ROUNDS NODE_ENV=$NODE_ENV bash ./scripts/deploy.sh

stages:
  - name: test
    if: "(type = push AND branch != master) OR (type = pull_request AND branch = master)"
  - name: deploy
    if: type = push AND branch = master
