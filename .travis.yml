language: node_js

node_js:
  - lts/*

env:
  global:
    - secure: rSyiWcNIeQnSZfpTFTRQT0hlZckaTenQVmHU1idsrYroiMn4J3KJxy9/4ISA99DMjDxgXX2S52r09TMVbFYdakL99sCsG6Mpwb6OlbzG9oAbW2j0jiHqfESWCTHipXifSUEDZB8h1XiWep2b90bdA9Jh/UbvXll0ykN1I5C3bK3LQO2RUWQaBrFwhOXuUPCdpOe7MKhZeXPXbCqx3IT+L3lWHlqscR4LkwgvRJp6i2C2cAHszoOeIme4LbmKhLUZ1yA5p5GwSrH9FjbXv22/wzkhMof64uBuAmsnafIOC1keRoG0a/HQGlQT6hNd+Xn4KGfFvnqb0xAoFsSKb3+CEdHcWmA+Q/s9DrCgH43i8J5Ts63JFPPS0wtqy0luigI50tIQOMTP3itanfju3DiMj/SF2lZnp5NyKjHo7VjO9/GkhJ/swi1qec56lT2o8DBvQaZoNoSxaTbhjdjt5ya7DlXE4Q3YWMJ/BthEmIHN8rrsFC5vQINi85DoOuaAzA0QwtYZWb6Xna1RkXZ2u33R6LUStaU0mS3zme16qaCrmEKIvTdBoahbZfDDdyrGboGZiN0GuXO/LQWoWNYEW6pypHAVfe2BngvNJECFIEkfTY2A76CcMoa/mObIEUAeRHVmAZTYfUO5AKk/OU24RZ5w5fBrHV7EQ8hGHUKOVrY4teA=
    - secure: lxUJVTEBdMLfjD9OxwfW2HOIFm3N25sA2hTeMh6IBJfybf6MEFWU9g2BZLrkegIHDzqdhcHYl4YZaHxHCbFAqUZdbcTGUmV3tjupEXSZpqQmjkZICrVxpJnjtwN7xz2pRxV5rAXVj0v98BF03Z1qw149E7s9DUL/IgVqOA8ENd/Pr6PN1k5LiAHhBa95UclQaP5DTi0trrRGLA9dB52qK9eqVGUpRu0i2lyQ3R5Sw+2hUlrfYYNeehWs88fPuohRACpskdXyCU/96eFcv+ID2SRi4yxrxycshnL859eCtGImw4EtJdRiIO35hJwWUHCXamX1M49m0T/cdrBjMX0y0gKDS2A9B7JvWve8635cMrjjaUx4jzce70dg8XpfgWOKUirNpCtnNv7cIwuxeUU+cc2l8LDvwejodIYT22x3mnWTdm83bJGVrgkuZcAU0h9nuxGNXP7nfke7MSFBK0AfAw1L/eQsWAvnVPoD2U9qpYn681PPDuJk8BYhg+SpxPdyUgCsctNTm0PqdJCuw090fW6OU2B9RTwFIZMh4mDciEj2fEy/wpTKn++L8snBAEvtrutlqSp+8RtkPOo/qADXldXff57dp+3N2PhrHFbFkstxuSJ87egMCBO2R0OFPOhvlFWGIqXWo7xaUSQxW2BYuI1brOanlrlfHqxcXgzX5Xc=

jobs:
  include:
    - stage: test
      services:
        - mysql
      env:
        - NODE_ENV=test
      before_install:
        - npm i npm yarn -g
        - mysql -e 'CREATE DATABASE database_test;'
      script:
        - yarn lint
        - yarn start:test
        - yarn test
        - cat ~/.pm2/logs/index-out.log
    - stage: deploy
      env:
        - NODE_ENV=production
      before_install:
        - openssl aes-256-cbc -K $encrypted_d80369b7a19f_key -iv $encrypted_d80369b7a19f_iv
          -in travis_rsa.enc -out travis_rsa -d
        - chmod 600 travis_rsa
        - mv travis_rsa ~/.ssh/id_rsa
        - mv travis_rsa.pub ~/.ssh/id_rsa.pub
      after_success:
        - JWT_SECRET=$JWT_SECRET SALT_ROUNDS=$SALT_ROUNDS NODE_ENV=$NODE_ENV bash ./scripts/deploy.sh

stages:
  - name: test
    if: "(type = push AND branch != master) OR (type = pull_request AND branch = master)"
  - name: deploy
    if: type = push AND branch = master
